rai:
  version: 0.2
  image: cwpearson/nvidia-performance-tools:amd64-10.1-master-c4d1bb1
resources:
  cpu:
    architecture: amd64
  gpu:
    count: 1
  network: false
  cache: false
commands:
  build:
    - env
    - nsys version
    - nv-nsight-cu-cli --version
    - echo "List supported metrics and sections"
    - #bash -c "nv-nsight-cu-cli --devices 0 --query-metrics | tee metrics.txt"
    - #bash -c "nv-nsight-cu-cli --list-sections             | tee sections.txt"
    - nvidia-smi
    - nsys status -e
    - cp -r /src .
    - cmake /src -DCMAKE_BUILD_TYPE=Release
    - make
    - echo "run without profiling"
    - ./sgemm-basic
    - ./sgemm-tiled
    - ./sgemm-regtiled-coarsened
    - echo "Nsight Compute"
    - nv-nsight-cu-cli --kernel-id ::mygemm:6 --section ".*" -o 0-pageable-basic       0-pageable-basic
    - nv-nsight-cu-cli --kernel-id ::mygemm:6 --section ".*" -o 1-pinned-basic         1-pinned-basic
    - nv-nsight-cu-cli --kernel-id ::mygemm:6 --section ".*" -o 2-pinned-tiled         2-pinned-tiled
    - nv-nsight-cu-cli --kernel-id ::mygemm:6 --section ".*" -o 3-pinned-joint         3-pinned-joint
    - nv-nsight-cu-cli --kernel-id ::mygemm:6 --section ".*" -o 4-pinned-joint-wall    4-pinned-joint-wall
    - nv-nsight-cu-cli --kernel-id ::mygemm:6 --section ".*" -o 5-pinned-joint-overlap 5-pinned-joint-overlap
    - echo "Nsight Systems timeline"
    - nsys profile -f true -o sgemm-basic.qdrep              sgemm-basic 
    - nsys profile -f true -o sgemm-tiled.qdrep              sgemm-tiled
    - nsys profile -f true -o sgemm-regtiled-coarsened.qdrep sgemm-regtiled-coarsened
    - du -sh .
