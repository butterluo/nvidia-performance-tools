rai:
  version: 0.2
  image: cwpearson/nvidia-performance-tools:amd64-10.1-master-ce03360
resources:
  cpu:
    architecture: amd64
  gpu:
    count: 1
  network: false
  cache: false
commands:
  build:
    - env
    - nsys version
    - nv-nsight-cu-cli --version
    - ls -l /usr/local/NVIDIA-Nsight-Compute
    - nvidia-smi
    - nsys status -e
    - cp -r /src .
    - cmake /src -DCMAKE_BUILD_TYPE=Release
    - make
    - echo "run without profiling"
    - ./sgemm-basic
    - ./sgemm-tiled
    - ./sgemm-regtiled-coarsened
    - echo "Nsight Compute"
    - nv-nsight-cu-cli --kernel-id ::mygemm:6 sgemm-basic
    - nv-nsight-cu-cli --kernel-id ::mygemm:6 sgemm-tiled
    - nv-nsight-cu-cli --kernel-id ::mygemm:6 sgemm-regtiled-coarsened
    - echo "Nsight Systems timeline"
    - nsys profile -f true -o sgemm-basic.qdrep              sgemm-basic 
    - nsys profile -f true -o sgemm-tiled.qdrep              sgemm-tiled
    - nsys profile -f true -o sgemm-regtiled-coarsened.qdrep sgemm-regtiled-coarsened
